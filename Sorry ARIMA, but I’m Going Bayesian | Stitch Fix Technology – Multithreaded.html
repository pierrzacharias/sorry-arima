<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sorry ARIMA, but I’m Going Bayesian | Stitch Fix Technology – Multithreaded</title>
  <meta name="description" content="When people think of “data science” they probably think of algorithms that scan large datasets to predict a customer’s next move or interpret unstructured te...">

  <meta name="og:title" content="Sorry ARIMA, but I’m Going Bayesian | Stitch Fix Technology – Multithreaded">
  <meta name="og:description" content="When people think of “data science” they probably think of algorithms that scan large datasets to predict a customer’s next move or interpret unstructured te...">

  <meta property="og:image" content="https://multithreaded.stitchfix.com/assets/images/logomark-linkedin.jpg" />

  <meta property="og:image" content="https://multithreaded.stitchfix.com/assets/images/logomark-facebook.jpg" />

  <meta name="twitter:image" content="https://multithreaded.stitchfix.com/assets/images/logomark-twitter.jpg" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@stitchfix_algo" />


  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="https://multithreaded.stitchfix.com/blog/2016/04/21/forget-arima/">
  <link rel="alternate" type="application/rss+xml" title="Stitch Fix Technology – Multithreaded" href="https://multithreaded.stitchfix.com/feed.xml" />

  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
  <script src="/assets/js/modernizr.custom.51181.js"></script>
  <script>
      var RimgOptions = {
          breakpoint:
                  '-tiny 320w 1x,    -tiny-retina 320w 2x,' +
                  '-small 480w 1x,   -small-retina 480w 2x,' +
                  '-medium 600w 1x,  -medium-retina 600w 2x,' +
                  '-regular 768w 1x, -regular-retina 768w 2x,' +
                  '-large 1024w 1x,  -large-retina 1024w 2x,' +
                  '-huge 1200w 1x,   -huge-retina 1200w 2x'
      }
  </script>
  <script src="/assets/js/rimg.min.js"></script>

  <!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
   new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
   })(window,document,'script','dataLayer','GTM-7RWHC');
</script>
<!-- End Google Tag Manager -->
<!-- Google Tag Manager (noscript) -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-7RWHC" height="0" width="0" style="display:none;visibility:hidden">
  </iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->


</head>

  <body class="blog-post">
    
<nav class="global-nav">
  <ul class="hidden-gtxs list-flex">
    <li>
      <a href="/" class="logo global-nav__item global-nav__item--logo left">
        <img src="/assets/images/svgs/logomark.svg" alt="Stitch Fix logomark">
      </a>
    </li>
    
      
      
      
      
        <li class="flex-4 ">
          <a href="/engineering"
             class="global-nav__item ">
            Engineering
          </a>
        </li>
    
      
      
      
      
        <li class="flex-4 ">
          <a href="/algorithms"
             class="global-nav__item ">
            Algorithms
          </a>
        </li>
    
      
      
      
      
        <li class="flex-3 nav-algorithms-tour">
          <a href="http://algorithms-tour.stitchfix.com/"
             class="global-nav__item ">
            Algorithms Tour
          </a>
        </li>
    
      
      
      
      
        <li class="flex-3 nav-tour">
          <a href="http://algorithms-tour.stitchfix.com/"
             class="global-nav__item ">
            Tour
          </a>
        </li>
    
      
      
      
      
        <li class="flex-3 ">
          <a href="https://www.stitchfix.com/careers/jobs"
             class="global-nav__item ">
            Careers
          </a>
        </li>
    
      
      
      
      
        <li class="flex-3 ">
          <a href="/blog"
             class="global-nav__item current">
            Blog
          </a>
        </li>
    
  </ul>
  <div class="hidden-xs container flex">
    <a href="/" class="logo global-nav__item global-nav__item--logo left">
        <img src="/assets/images/svgs/logov5.svg" alt="Stitch Fix logo">
    </a>
    <div class="right">
      
        
        
          <a href="/engineering"
             class="global-nav__item  ">
            Engineering
          </a>
      
        
        
          <a href="/algorithms"
             class="global-nav__item  ">
            Algorithms
          </a>
      
        
        
          <a href="http://algorithms-tour.stitchfix.com/"
             class="global-nav__item  nav-algorithms-tour">
            Algorithms Tour
          </a>
      
        
        
          <a href="http://algorithms-tour.stitchfix.com/"
             class="global-nav__item  nav-tour">
            Tour
          </a>
      
        
        
          <a href="https://www.stitchfix.com/careers/jobs"
             class="global-nav__item  ">
            Careers
          </a>
      
        
        
          <a href="/blog"
             class="global-nav__item current ">
            Blog
          </a>
      
    </div>
  </div>
</nav>

    <div class="container contain-to-sm">
      <header class="mt6 mb2">
        <h1 class="h1 mb1 text-c h-limited">Sorry ARIMA, but I’m Going Bayesian</h1>

        <div style="display: flex; justify-content: center;">
          <div
            style="margin: 0 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center;"
          >
            <aside class="authors-row">
               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                 
                                                                                                                                                                             
              <img
                src="/assets/images/team/kim-larsen.jpg"
                class="blog-post__author-image circleimage"
                alt="Blog post by Kim Larsen"
              />
                                                                                                                                                                           
            </aside>

            <div class="blog-meta">
              <h6 class="h6 heading--impact m1">
                
                Kim Larsen
                
              </h6>
            </div>
          </div>

          <div
            style="display: flex; flex-direction: column; align-items: center; justify-content: center;"
          >
            <aside class="authors-row">
              
            </aside>
            
          </div>
        </div>

        <div class="blog-meta">
          <h6 class="thin text-c">
            <time datetime="2016-04-21">April 21, 2016</time>
            
            <span class="location"> - San Francisco, CA </span>
            
          </h6>
        </div>

        <div class="thin text-c m1">
          <a href="https://twitter.com/intent/tweet?text=Sorry ARIMA, but I’m Going Bayesian&url=https://multithreaded.stitchfix.com/blog/2016/04/21/forget-arima/&via=stitchfix_algo" target="_" class="social-share">
  <span class="icon twitter"></span>
  <span>Tweet this post!</span>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=https://multithreaded.stitchfix.com/blog/2016/04/21/forget-arima/&title=Sorry ARIMA, but I’m Going Bayesian&summary=When people think of “data science” they probably think of algorithms that scan large datasets to predict a customer’s next move or interpret unstructured te...&source=Stitch%20Fix%20Technology%20%E2%80%93%20Multithreaded" target="_" class="social-share">
  <span class="icon linkedin"></span>
  <span>Post on LinkedIn</span>
</a>


        </div>
      </header>
    </div>
    <div class="container contain-to-sm pos-rel">
      <article>
        <section class="text-content">
          <p>When people think of “data science” they probably think of algorithms that scan large datasets to predict a customer’s next move or interpret unstructured text. But what about models that utilize small, time-stamped datasets to forecast dry metrics such as demand and sales? Yes, I’m talking about good old time series analysis, an ancient discipline that hasn’t received the cool “data science” rebranding enjoyed by many other areas of analytics.</p>

<p>Yet, analysis of time series data presents some of the most difficult analytical challenges: you typically have the least amount of data to work with, while needing to inform some of the most important decisions. For example, time series analysis is frequently used to do demand forecasting for corporate planning, which requires an understanding of seasonality and trend, as well as quantifying the impact of known business drivers. But herein lies the problem: you rarely have sufficient historical data to estimate these components with good precision. And, to make matters worse, validation is more difficult for time series models than it is for classifiers and your audience may not be comfortable with the embedded uncertainty.</p>

<p>So, how does one navigate such treacherous waters? You need business acumen, luck, and <em>Bayesian structural time series models</em>. In my opinion, these models are more transparent than <a href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average">ARIMA</a> – which still tends to be the go-to method. They also facilitate better handling of uncertainty, a key feature when planning for the future. In this post I will provide a gentle intro the <code class="highlighter-rouge">bsts</code> R package written by Steven L. Scott at Google. Note that the <code class="highlighter-rouge">bsts</code> package is also being used by the <code class="highlighter-rouge">CausalImpact</code> package written by Kay Brodersen, which I discussed in this <a href="http://multithreaded.stitchfix.com/blog/2016/01/13/market-watch/">post from January</a>.</p>

<h2 id="airline-passenger-data">Airline Passenger Data</h2>

<h3 id="an-arima-model">An ARIMA Model</h3>

<p>First, let’s start by fitting a classical ARIMA (autoregressive integrated moving average) model to the famous airline passenger dataset. The ARIMA model has the following characteristics:</p>

<ul>
  <li>First order differencing (<script type="math/tex">d=1</script>) and a moving average term (<script type="math/tex">q=1</script>)</li>
  <li>Seasonal differencing and a seasonal MA term</li>
  <li>The year of 1960 was used as the holdout period for validation</li>
  <li>Using a log transformation to model the growth rate</li>
</ul>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bsts</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">forecast</span><span class="p">)</span><span class="w">


</span><span class="c1">### Load the data</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="s2">"AirPassengers"</span><span class="p">)</span><span class="w">
</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">window</span><span class="p">(</span><span class="n">AirPassengers</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1949</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">end</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1959</span><span class="p">,</span><span class="m">12</span><span class="p">))</span><span class="w">

</span><span class="c1">### Fit the ARIMA model</span><span class="w">
</span><span class="n">arima</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">arima</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span><span class="w"> 
               </span><span class="n">order</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> 
               </span><span class="n">seasonal</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">period</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="w">

</span><span class="c1">### Actual versus predicted</span><span class="w">
</span><span class="n">d1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">fitted</span><span class="p">(</span><span class="n">arima</span><span class="p">)),</span><span class="w"> </span><span class="c1"># fitted and predicted</span><span class="w">
                   </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">arima</span><span class="p">,</span><span class="w"> </span><span class="n">n.ahead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="o">$</span><span class="n">pred</span><span class="p">)),</span><span class="w">
                   </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">AirPassengers</span><span class="p">),</span><span class="w"> </span><span class="c1">#actual values</span><span class="w">
                   </span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">AirPassengers</span><span class="p">)))</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Fitted"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Actual"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">


</span><span class="c1">### MAPE (mean absolute percentage error)</span><span class="w">
</span><span class="n">MAPE</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="o">&gt;</span><span class="m">1959</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">summarise</span><span class="p">(</span><span class="n">MAPE</span><span class="o">=</span><span class="n">mean</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Actual</span><span class="o">-</span><span class="n">Fitted</span><span class="p">)</span><span class="o">/</span><span class="n">Actual</span><span class="p">))</span><span class="w">

</span><span class="c1">### Plot actual versus predicted</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d1</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Date</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Actual</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Actual"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Fitted</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Fitted"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1.2</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"1959-12-01"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"ARIMA -- Holdout MAPE = "</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="m">100</span><span class="o">*</span><span class="n">MAPE</span><span class="p">,</span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="s2">"%"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div align="middle">
<img src="/assets/posts/2016-04-21-forget-arima/fig1.png" width="70%" />
</div>

<p>This model predicts the holdout period quite well as measured by the MAPE (mean absolute percentage error). However, the model does not tell us much about the time series itself. In other words, we cannot visualize the “story” of the model. All we know is that we can fit the data well using a combination of moving averages and lagged terms.</p>

<h3 id="a-bayesian-structural-time-series-model">A Bayesian Structural Time Series Model</h3>
<p>A different approach would be to use a Bayesian structural time series model with unobserved components. This technique is more transparent than ARIMA models and deals with uncertainty in a more elegant manner. It is more transparent because its representation does not rely on differencing, lags and moving averages. You can visually inspect the underlying components of the model. It handles uncertainty in a better way because you can quantify the posterior uncertainty of the individual components, control the variance of the components, and impose prior beliefs on the model. Last, but not least, any ARIMA model can be recast as a structural model.</p>

<p>Generally, we can write a Bayesian structural model like this:</p>

<script type="math/tex; mode=display">\large Y_t = \mu_t + x_t \beta + S_t + e_t, e_t \sim N(0, \sigma^2_e)</script>

<script type="math/tex; mode=display">\large \mu_{t+1} = \mu_t + \nu_t, \nu_t \sim N(0, \sigma^2_{\nu}).</script>

<p>Here <script type="math/tex">x_t</script> denotes a set of regressors, <script type="math/tex">S_t</script> represents seasonality, and <script type="math/tex">\mu_t</script> is the <em>local level</em> term. The local level term defines how the latent state evolves over time and is often referred to as the <em>unobserved trend</em>. This could, for example, represent an underlying growth in the brand value of a company or external factors that are hard to pinpoint, but it can also soak up short term fluctuations that should be controlled for with explicit terms. Note that the regressor coefficients, seasonality and trend are estimated <em>simultaneously</em>, which helps avoid strange coefficient estimates due to spurious relationships (similar in spirit to Granger causality, see <sup><a href="#footnote2">1</a></sup>). In addition, due to the Bayesian nature of the model, we can shrink the elements of <script type="math/tex">\beta</script> to promote sparsity or specify outside priors for the means in case we’re not able to get meaningful estimates from the historical data (more on this later).</p>

<p>The airline passenger dataset does not have any regressors, and so we’ll fit a simple Bayesian structural model:</p>

<ul>
  <li>500 MCMC draws</li>
  <li>Use 1960 as the holdout period</li>
  <li>Trend and seasonality</li>
  <li>Forecast created by averaging across the MCMC draws</li>
  <li>Credible interval generated from the distribution of the MCMC draws</li>
  <li>Discarding the first MCMC iterations (burn-in)</li>
  <li>Using a log transformation to make the model multiplicative</li>
</ul>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bsts</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">

</span><span class="c1">### Load the data</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="s2">"AirPassengers"</span><span class="p">)</span><span class="w">
</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">window</span><span class="p">(</span><span class="n">AirPassengers</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1949</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">end</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1959</span><span class="p">,</span><span class="m">12</span><span class="p">))</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w">


</span><span class="c1">### Run the bsts model</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddLocalLinearTrend</span><span class="p">(</span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddSeasonal</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">nseasons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w">
</span><span class="n">bsts.model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bsts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">state.specification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">niter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">ping</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">=</span><span class="m">2016</span><span class="p">)</span><span class="w">

</span><span class="c1">### Get a suggested number of burn-ins</span><span class="w">
</span><span class="n">burn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">SuggestBurn</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">bsts.model</span><span class="p">)</span><span class="w">

</span><span class="c1">### Predict</span><span class="w">
</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict.bsts</span><span class="p">(</span><span class="n">bsts.model</span><span class="p">,</span><span class="w"> </span><span class="n">horizon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">burn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">burn</span><span class="p">,</span><span class="w"> </span><span class="n">quantiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">.025</span><span class="p">,</span><span class="w"> </span><span class="m">.975</span><span class="p">))</span><span class="w">

</span><span class="c1">### Actual versus predicted</span><span class="w">
</span><span class="n">d2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
    </span><span class="c1"># fitted values and predictions</span><span class="w">
    </span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="o">-</span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.model</span><span class="o">$</span><span class="n">one.step.prediction.errors</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),])</span><span class="o">+</span><span class="n">y</span><span class="p">),</span><span class="w">  
    </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">mean</span><span class="p">)),</span><span class="w">
    </span><span class="c1"># actual data and dates </span><span class="w">
    </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">AirPassengers</span><span class="p">),</span><span class="w">
    </span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">AirPassengers</span><span class="p">)))</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Fitted"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Actual"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">

</span><span class="c1">### MAPE (mean absolute percentage error)</span><span class="w">
</span><span class="n">MAPE</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="o">&gt;</span><span class="m">1959</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">summarise</span><span class="p">(</span><span class="n">MAPE</span><span class="o">=</span><span class="n">mean</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">Actual</span><span class="o">-</span><span class="n">Fitted</span><span class="p">)</span><span class="o">/</span><span class="n">Actual</span><span class="p">))</span><span class="w">

</span><span class="c1">### 95% forecast credible interval</span><span class="w">
</span><span class="n">posterior.interval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind.data.frame</span><span class="p">(</span><span class="w">
  </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">interval</span><span class="p">[</span><span class="m">1</span><span class="p">,]),</span><span class="w">
  </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">interval</span><span class="p">[</span><span class="m">2</span><span class="p">,]),</span><span class="w"> 
  </span><span class="n">subset</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="o">&gt;</span><span class="m">1959</span><span class="p">)</span><span class="o">$</span><span class="n">Date</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">posterior.interval</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"LL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"UL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">

</span><span class="c1">### Join intervals to the forecast</span><span class="w">
</span><span class="n">d3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">left_join</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span><span class="w"> </span><span class="n">posterior.interval</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="o">=</span><span class="s2">"Date"</span><span class="p">)</span><span class="w">

</span><span class="c1">### Plot actual versus predicted with credible intervals for the holdout period</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d3</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Date</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Actual</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Actual"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1.2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Fitted</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Fitted"</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="m">1.2</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">as.Date</span><span class="p">(</span><span class="s2">"1959-12-01"</span><span class="p">)),</span><span class="w"> </span><span class="n">linetype</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">LL</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="o">=</span><span class="n">UL</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">ggtitle</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"BSTS -- Holdout MAPE = "</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="m">100</span><span class="o">*</span><span class="n">MAPE</span><span class="p">,</span><span class="m">2</span><span class="p">),</span><span class="w"> </span><span class="s2">"%"</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div align="middle">
<img src="/assets/posts/2016-04-21-forget-arima/fig2.png" width="70%" />
</div>

<h4 id="side-notes-on-the-bsts-examples-in-this-post">Side Notes on the <code class="highlighter-rouge">bsts</code> Examples in this Post</h4>

<ul>
  <li>When building Bayesian models we get a distribution and not a single answer. Thus, the <code class="highlighter-rouge">bsts</code> package returns results (e.g., forecasts and components) as matrices or arrays where the first dimension holds the MCMC iterations.</li>
  <li>Most of the plots in this post show point estimates from averaging (using the <code class="highlighter-rouge">colMeans</code> function). But it’s very easy to get distributions from the MCMC draws, and this is recommended in real life to better quantify uncertainty.</li>
  <li>For visualization, I went with <code class="highlighter-rouge">ggplot</code> for this example in order to demonstrate how to retrieve the output for custom plotting. Alternatively, we can simply use the <code class="highlighter-rouge">plot.bsts</code> function that comes with the <code class="highlighter-rouge">bsts</code> package.</li>
</ul>

<p>Note that the <code class="highlighter-rouge">predict.bsts</code> function automatically supplies the upper and lower limits for a credible interval (95% in our case). We can also access the distribution for all MCMC draws by grabbing the <code class="highlighter-rouge">distribution</code> matrix (instead of <code class="highlighter-rouge">interval</code>). Each row in this matrix is one MCMC draw. Here’s an example of how to calculate percentiles from the posterior distribution:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">credible.interval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind.data.frame</span><span class="p">(</span><span class="w">
  </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">distribution</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="k">function</span><span class="p">(</span><span class="n">f</span><span class="p">){</span><span class="n">quantile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="m">0.75</span><span class="p">)})),</span><span class="w">
  </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">distribution</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="k">function</span><span class="p">(</span><span class="n">f</span><span class="p">){</span><span class="n">median</span><span class="p">(</span><span class="n">f</span><span class="p">)})),</span><span class="w">
  </span><span class="m">10</span><span class="o">^</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">p</span><span class="o">$</span><span class="n">distribution</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="k">function</span><span class="p">(</span><span class="n">f</span><span class="p">){</span><span class="n">quantile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="m">0.25</span><span class="p">)})),</span><span class="w">
  </span><span class="n">subset</span><span class="p">(</span><span class="n">d3</span><span class="p">,</span><span class="w"> </span><span class="n">year</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span><span class="o">&gt;</span><span class="m">1959</span><span class="p">)</span><span class="o">$</span><span class="n">Date</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">credible.interval</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"p75"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Median"</span><span class="p">,</span><span class="w"> </span><span class="s2">"p25"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<p>Although the holdout MAPE (mean absolute percentage error) is larger than the ARIMA model for this specific dataset (and default settings), the <code class="highlighter-rouge">bsts</code> model does a great job of capturing the growth and seasonality of the air passengers time series. Moreover, one of the big advantages of the Bayesian structural model is that we can visualize the underlying components. In this example, we’re using <code class="highlighter-rouge">ggplot</code> to plot the average of the MCMC draws for the trend and the seasonal components:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bsts</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span><span class="w">

</span><span class="c1">### Set up the model</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="s2">"AirPassengers"</span><span class="p">)</span><span class="w">
</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">window</span><span class="p">(</span><span class="n">AirPassengers</span><span class="p">,</span><span class="w"> </span><span class="n">start</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1949</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">end</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1959</span><span class="p">,</span><span class="m">12</span><span class="p">))</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddLocalLinearTrend</span><span class="p">(</span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddSeasonal</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">nseasons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">)</span><span class="w">
</span><span class="n">bsts.model</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bsts</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">state.specification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">niter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">ping</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">=</span><span class="m">2016</span><span class="p">)</span><span class="w">

</span><span class="c1">### Get a suggested number of burn-ins</span><span class="w">
</span><span class="n">burn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">SuggestBurn</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">bsts.model</span><span class="p">)</span><span class="w">

</span><span class="c1">### Extract the components</span><span class="w">
</span><span class="n">components</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind.data.frame</span><span class="p">(</span><span class="w">
  </span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.model</span><span class="o">$</span><span class="n">state.contributions</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),</span><span class="s2">"trend"</span><span class="p">,]),</span><span class="w">                               
  </span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.model</span><span class="o">$</span><span class="n">state.contributions</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),</span><span class="s2">"seasonal.12.1"</span><span class="p">,]),</span><span class="w">
  </span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">Y</span><span class="p">)))</span><span class="w">  
</span><span class="nf">names</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Trend"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Seasonality"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">
</span><span class="n">components</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">melt</span><span class="p">(</span><span class="n">components</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">"Date"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Date"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Component"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">)</span><span class="w">

</span><span class="c1">### Plot</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">components</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="o">=</span><span class="s2">"free"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">guides</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div align="middle">
<img src="/assets/posts/2016-04-21-forget-arima/fig3.png" width="80%" />
</div>

<p>Here we can clearly the seasonal pattern of airline passengers as well as how the airline industry grew during this period.</p>

<h2 id="bayesian-variable-selection">Bayesian Variable Selection</h2>
<p>Another advantage of Bayesian structural models is the ability to use spike-and-slab priors. This provides a powerful way of reducing a large set of correlated variables into a parsimonious model, while also imposing prior beliefs on the model. Furthermore, by using priors on the regressor coefficients, the model incorporates uncertainties of the coefficient estimates when producing the credible interval for the forecasts.</p>

<p>As the name suggests, spike and slab priors consist of two parts: the <em>spike</em> part and the <em>slab</em> part. The spike part governs the probability of a given variable being chosen for the model (i.e., having a non-zero coefficient). The slab part shrinks the non-zero coefficients toward prior expectations (often zero). To see how this works, let <script type="math/tex">\tau</script> denote a vector of 1s and 0s where a value of 1 indicates that the variable is selected (non-zero coefficient). We can factorize the spike and slab prior as follows (see <sup><a href="#footnote1">1</a></sup>) :</p>

<script type="math/tex; mode=display">\large p(\tau, \beta, 1/\sigma^2_{\epsilon}) =  p(\tau)p(\sigma^2_{\epsilon} \text{ } | \text{ } \tau) p(\beta \text{ } | \text{ } \tau, \sigma^2_{\epsilon})</script>

<p><a name="footnote1-return"></a>The probability of choosing a given variable is typically assumed to follow a Bernoulli distribution where the parameter can be set according to the expected model size. For example, if the expected model size is 5 and we have 50 potential variables, we could set all spike parameters equal to 0.1. Alternatively, we can also set individual spike parameters to 0 or 1 to force certain variables in or out of the model.</p>

<p>For the slab part, a normal prior is used for <script type="math/tex">\beta</script> which leads to an inverse Gamma prior for <script type="math/tex">\sigma^2_{\epsilon}</script>. The mean is specified through the prior expectations for <script type="math/tex">\beta</script> (zero by default). The tightness of the priors can be expressed in terms of observations worth of weight (demonstrated later). For more technical information see <sup><a href="#footnote1">1</a></sup> .</p>

<h3 id="using-spike-and-slab-priors-for-the-initial-claims-data">Using Spike and Slab Priors for the Initial Claims Data</h3>
<p>Here’s an example of fitting a model to the initial claims data, which is a weekly time series of US initial claims for unemployment (the first column is the dependent variable, which contains the initial claims numbers from FRED). The model has a trend component, a seasonal component, and a regression component.</p>

<p>For model selection, we are essentially using the “spike” part of the algorithm to select variables and the “slab” part to shrink the coefficients towards zero (akin to ridge regression).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bsts</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span><span class="w">

</span><span class="c1">### Fit the model with regressors</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">iclaims</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddLocalLinearTrend</span><span class="p">(</span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">initial.claims</span><span class="o">$</span><span class="n">iclaimsNSA</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddSeasonal</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">initial.claims</span><span class="o">$</span><span class="n">iclaimsNSA</span><span class="p">,</span><span class="w"> </span><span class="n">nseasons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">52</span><span class="p">)</span><span class="w">
</span><span class="n">bsts.reg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bsts</span><span class="p">(</span><span class="n">iclaimsNSA</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">state.specification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w">
                </span><span class="n">initial.claims</span><span class="p">,</span><span class="w"> </span><span class="n">niter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">ping</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">=</span><span class="m">2016</span><span class="p">)</span><span class="w">

</span><span class="c1">### Get the number of burn-ins to discard</span><span class="w">
</span><span class="n">burn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">SuggestBurn</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">bsts.reg</span><span class="p">)</span><span class="w">

</span><span class="c1">### Helper function to get the positive mean of a vector</span><span class="w">
</span><span class="n">PositiveMean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="nf">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">]</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> 
    </span><span class="nf">return</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">### Get the average coefficients when variables were selected (non-zero slopes)</span><span class="w">
</span><span class="n">coeff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">melt</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">bsts.reg</span><span class="o">$</span><span class="n">coefficients</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),],</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">PositiveMean</span><span class="p">)))</span><span class="w">
</span><span class="n">coeff</span><span class="o">$</span><span class="n">Variable</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">row.names</span><span class="p">(</span><span class="n">coeff</span><span class="p">))</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">coeff</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Variable</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Average coefficients"</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<div align="middle">
<img src="/assets/posts/2016-04-21-forget-arima/fig4.png" width="80%" />
</div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">### Inclusion probabilities -- i.e., how often were the variables selected </span><span class="w">
</span><span class="n">inclusionprobs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">melt</span><span class="p">(</span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.reg</span><span class="o">$</span><span class="n">coefficients</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
</span><span class="n">inclusionprobs</span><span class="o">$</span><span class="n">Variable</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">row.names</span><span class="p">(</span><span class="n">inclusionprobs</span><span class="p">))</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inclusionprobs</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Variable</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ggtitle</span><span class="p">(</span><span class="s2">"Inclusion probabilities"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div align="middle">
<img src="/assets/posts/2016-04-21-forget-arima/fig5.png" width="80%" />
</div>

<p>The output shows that the model is dominated by two variables: <code class="highlighter-rouge">unemployment.office</code> and <code class="highlighter-rouge">idaho.unemployment</code>. These variables have the largest average coefficients and were selected in 100% of models. Note that if we want to inspect the distributions of the coefficients, we can can simply calculate quantiles instead of the mean inside the helper function above:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">P75</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="nf">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">]</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> 
    </span><span class="nf">return</span><span class="p">(</span><span class="n">quantile</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="m">0.75</span><span class="p">))</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">p75</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">melt</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">bsts.reg</span><span class="o">$</span><span class="n">coefficients</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),],</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">P75</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>And we can easily visualize the overall contribution of these variables to the model:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bsts</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span><span class="w">

</span><span class="c1">### Fit the model with regressors</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">iclaims</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddLocalLinearTrend</span><span class="p">(</span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">initial.claims</span><span class="o">$</span><span class="n">iclaimsNSA</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddSeasonal</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">initial.claims</span><span class="o">$</span><span class="n">iclaimsNSA</span><span class="p">,</span><span class="w"> </span><span class="n">nseasons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">52</span><span class="p">)</span><span class="w">
</span><span class="n">bsts.reg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bsts</span><span class="p">(</span><span class="n">iclaimsNSA</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">state.specification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w">
                </span><span class="n">initial.claims</span><span class="p">,</span><span class="w"> </span><span class="n">niter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">ping</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">=</span><span class="m">2016</span><span class="p">)</span><span class="w">

</span><span class="c1">### Get the number of burn-ins to discard</span><span class="w">
</span><span class="n">burn</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">SuggestBurn</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="n">bsts.reg</span><span class="p">)</span><span class="w">

</span><span class="c1">### Get the components</span><span class="w">
</span><span class="n">components.withreg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cbind.data.frame</span><span class="p">(</span><span class="w">
  </span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.reg</span><span class="o">$</span><span class="n">state.contributions</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),</span><span class="s2">"trend"</span><span class="p">,]),</span><span class="w">
  </span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.reg</span><span class="o">$</span><span class="n">state.contributions</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),</span><span class="s2">"seasonal.52.1"</span><span class="p">,]),</span><span class="w">
  </span><span class="n">colMeans</span><span class="p">(</span><span class="n">bsts.reg</span><span class="o">$</span><span class="n">state.contributions</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),</span><span class="s2">"regression"</span><span class="p">,]),</span><span class="w">
  </span><span class="n">as.Date</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">initial.claims</span><span class="p">)))</span><span class="w">  
</span><span class="nf">names</span><span class="p">(</span><span class="n">components.withreg</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Trend"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Seasonality"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Regression"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Date"</span><span class="p">)</span><span class="w">
</span><span class="n">components.withreg</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">melt</span><span class="p">(</span><span class="n">components.withreg</span><span class="p">,</span><span class="w"> </span><span class="n">id.vars</span><span class="o">=</span><span class="s2">"Date"</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">components.withreg</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Date"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Component"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Value"</span><span class="p">)</span><span class="w">

</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">components.withreg</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">Value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_line</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">facet_grid</span><span class="p">(</span><span class="n">Component</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">scales</span><span class="o">=</span><span class="s2">"free"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">guides</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>
<div align="middle">
<img src="/assets/posts/2016-04-21-forget-arima/fig6.png" width="80%" />
</div>

<h3 id="including-prior-expectations-in-the-model">Including Prior Expectations in the Model</h3>
<p>In the example above, we used the spike-and-slab prior as a way to select variables and promote sparsity. However, we can also use this framework to impose <em>prior beliefs</em> on the model. These prior beliefs could come from an outside study or a previous version of the model. This is a common use-case in time series regression; we cannot always rely on the data at hand to tell you how known business drivers affect the outcome.</p>

<p>In the <code class="highlighter-rouge">bsts</code> package, this is done by passing a prior object as created by the <code class="highlighter-rouge">SpikeSlabPrior</code> function. In this example we are specifying a prior of 0.6 on the variable called <code class="highlighter-rouge">unemployment.office</code> and forcing this variable to be selected by setting its prior spike parameter to 1. We’re giving our priors a weight of 200 (measured in observation count), which is fairly large given that the dataset has 456 records. Hence we should expect the posterior to be very close to 0.6.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">bsts</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">reshape2</span><span class="p">)</span><span class="w">

</span><span class="n">data</span><span class="p">(</span><span class="n">iclaims</span><span class="p">)</span><span class="w">

</span><span class="n">prior.spikes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0.1</span><span class="p">)</span><span class="w">
</span><span class="n">prior.mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0.6</span><span class="p">,</span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="c1">### Helper function to get the positive mean of a vector</span><span class="w">
</span><span class="n">PositiveMean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="nf">abs</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">]</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> 
    </span><span class="nf">return</span><span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">### Set up the priors</span><span class="w">
</span><span class="n">prior</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">SpikeSlabPrior</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">model.matrix</span><span class="p">(</span><span class="n">iclaimsNSA</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">initial.claims</span><span class="p">),</span><span class="w"> 
                        </span><span class="n">y</span><span class="o">=</span><span class="n">initial.claims</span><span class="o">$</span><span class="n">iclaimsNSA</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">prior.information.weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">200</span><span class="p">,</span><span class="w">
                        </span><span class="n">prior.inclusion.probabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prior.spikes</span><span class="p">,</span><span class="w">
                        </span><span class="n">optional.coefficient.estimate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prior.mean</span><span class="p">)</span><span class="w">
                        
</span><span class="c1">### Run the bsts model with the specified priors</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="n">iclaims</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddLocalLinearTrend</span><span class="p">(</span><span class="nf">list</span><span class="p">(),</span><span class="w"> </span><span class="n">initial.claims</span><span class="o">$</span><span class="n">iclaimsNSA</span><span class="p">)</span><span class="w">
</span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AddSeasonal</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="w"> </span><span class="n">initial.claims</span><span class="o">$</span><span class="n">iclaimsNSA</span><span class="p">,</span><span class="w"> </span><span class="n">nseasons</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">52</span><span class="p">)</span><span class="w">
</span><span class="n">bsts.reg.priors</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bsts</span><span class="p">(</span><span class="n">iclaimsNSA</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">state.specification</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initial.claims</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">niter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">ping</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="o">=</span><span class="m">2016</span><span class="p">)</span><span class="w">


</span><span class="c1">### Get the average coefficients when variables were selected (non-zero slopes)</span><span class="w">
</span><span class="n">coeff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">melt</span><span class="p">(</span><span class="n">apply</span><span class="p">(</span><span class="n">bsts.reg.priors</span><span class="o">$</span><span class="n">coefficients</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">burn</span><span class="p">),],</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">PositiveMean</span><span class="p">)))</span><span class="w">
</span><span class="n">coeff</span><span class="o">$</span><span class="n">Variable</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">row.names</span><span class="p">(</span><span class="n">coeff</span><span class="p">))</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">coeff</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Variable</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="o">=</span><span class="s2">"identity"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="o">=</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-90</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> 
  </span><span class="n">xlab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ylab</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div align="middle">
<img src="/assets/posts/2016-04-21-forget-arima/fig7.png" width="80%" />
</div>

<p>As we can see, the posterior for <code class="highlighter-rouge">unemployment.office</code> is being forced towards 0.6 due to the strong prior belief that we imposed on the coefficient.</p>

<h2 id="last-words">Last Words</h2>
<p>Bayesian structural time series models possess three key features for modeling time series data:</p>

<ul>
  <li>Ability to incorporate uncertainty into our forecasts so we quantify future risk</li>
  <li>Transparency, so we can truly understand how the model works</li>
  <li>Ability to incorporate outside information for known business drivers when we cannot extract the relationships from the data at hand</li>
</ul>

<p>Having said that, there is no silver bullet when it comes to forecasting and scenario planning. No tool or method can remove the embedded uncertainty or extract clear signals from murky or limited data. Bayesian structural modeling merely maximizes your chances of success.</p>

<p><a name="footnote1"></a></p>

<h2 id="getting-the-code-used-in-this-post">Getting the Code Used in this Post</h2>
<p><a href="https://github.com/klarsen1/bstspost">github repo</a>. Use the .Rmd file.</p>

<p><br /><br /></p>

<hr />

<p><span style="font-size:medium;">
<sup>1</sup>
CausalImpact version 1.0.3, Brodersen et al., Annals of Applied Statistics (2015). http://google.github.io/CausalImpact/
<a href="#footnote1-return">←</a>
</span></p>

<p><span style="font-size:medium;">
<sup>2</sup>
Predicting the Present with Bayesian Structural Time Series, Steven L. Scott and Hal Varian, http://people.ischool.berkeley.edu/~hal/Papers/2013/pred-present-with-bsts.pdf.
</span></p>


        </section>
      </article>
    </div>

    <div class="thin text-c mt2">
      <a href="https://twitter.com/intent/tweet?text=Sorry ARIMA, but I’m Going Bayesian&url=https://multithreaded.stitchfix.com/blog/2016/04/21/forget-arima/&via=stitchfix_algo" target="_" class="social-share">
  <span class="icon twitter"></span>
  <span>Tweet this post!</span>
</a>

<a href="https://www.linkedin.com/shareArticle?mini=true&url=https://multithreaded.stitchfix.com/blog/2016/04/21/forget-arima/&title=Sorry ARIMA, but I’m Going Bayesian&summary=When people think of “data science” they probably think of algorithms that scan large datasets to predict a customer’s next move or interpret unstructured te...&source=Stitch%20Fix%20Technology%20%E2%80%93%20Multithreaded" target="_" class="social-share">
  <span class="icon linkedin"></span>
  <span>Post on LinkedIn</span>
</a>


    </div>

    <div class="divider py4 text-c">
      <img
        src="/assets/images/svgs/logomark.svg"
        width="60"
        alt="Multithreaded"
      />
    </div>

    <section class="py4 text-c">
  <div class="container contain-to-md">
    <h2 class="h2 heading--impact">Come Work with Us!</h2>
    <p class="text-c p-limited">
      We’re a diverse team dedicated to building great products, and we’d love your help. Do you want to build
      amazing products with amazing peers? Join us!
    </p>
    <footer class="m2">
      <a href="http://stitchfix.com/careers/jobs" class="btn-cta m1 mr1 ml1">All Careers at Stitch Fix</a>
    </footer>
  </div>
</section> <div class="container">
  <footer class="global-footer">
    <div class="global-footer__content">
      <section class="footer-column--brand">
        <img src="/assets/images/svgs/StitchFix%20Tagline%20leftalign%20SVG.svg" class="footer-logo" alt="Stitch Fix: Your partner in personal style">
        <small class="copyright">Stitch Fix and Fix are<br>trademarks of Stitch Fix, Inc.</small>
      </section>
      <section class="footer-column--links">
        <div class="links-container">
          <ul class="links-list">
            <li><a href="https://www.stitchfix.com">Stitch Fix Home</a></li>
            <li><a href="https://www.stitchfix.com/faq">FAQ</a></li>
            <li><a href="https://www.stitchfix.com/press">Press</a></li>
          </ul>
          <ul class="links-list">
            <li><a href="http://multithreaded.stitchfix.com/blog/">Tech Blog</a></li>
            <li><a href="http://multithreaded.stitchfix.com/careers/">Tech Careers</a></li>
          </ul>
          <ul class="links-list">
            <li><a href="https://www.stitchfix.com/terms">Terms of Use</a></li>
            <li><a href="https://www.stitchfix.com/privacy">Privacy Policy</a></li>
          </ul>
        </div>
      </section>
      <section class="footer-column--social">
        <h5 class="f-sm mb1">Follow Us!</h5>
        <a href="http://github.com/stitchfix" class="pxhalf">
          <img src="/assets/images/svgs/socialgithub.svg" width="33" height="32" alt="Stitch Fix Tech on Github">
        </a>
      </section>
    </div>

    <div class="global-footer__content-small-views">
      <section class="m4">
        <h5 class="f-sm mb1">Follow Us!</h5>
        <a href="http://github.com/stitchfix" class="pxhalf">
          <img src="/assets/images/svgs/socialgithub.svg" width="33" height="32" alt="Stitch Fix Tech on Github">
        </a>
      </section>
      <ul class="links-list--small-views">
        <li><a href="http://multithreaded.stitchfix.com/blog/">Tech Blog</a></li>
        <li><a href="http://multithreaded.stitchfix.com/careers/">Tech Careers</a></li>
        <li><a href="https://www.stitchfix.com">Stitch Fix Home</a></li>
        <li><a href="https://www.stitchfix.com/faq">FAQ</a></li>
        <li><a href="https://www.stitchfix.com/press">Press</a></li>
        <li><a href="https://www.stitchfix.com/terms">Terms of Use</a></li>
        <li><a href="https://www.stitchfix.com/privacy">Privacy Policy</a></li>
      </ul>
      <section class="copyright m1">
        <div class="mb1">Stitch Fix and Fix are trademarks of Stitch Fix, Inc.</div>
        <img src="/assets/images/svgs/sf_logomark.svg" width="33" height="32" alt="Stitch Fix logomark">
      </section>
    </div>
  </footer>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-25598599-8', 'auto');
  ga('send', 'pageview');

</script>

 <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </body>
</html>
